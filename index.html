<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì¿ í° ì½”ë“œ OCR ì¸ì‹ê¸°</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 15px; max-width: 640px; margin: auto; }
    canvas { width: 100%; border: 2px solid #4CAF50; border-radius: 6px; margin-bottom: 10px; touch-action: none; }
    .controls { margin-bottom: 10px; }
    button, select { margin: 5px 5px 5px 0; padding: 8px 12px; font-size: 1em; }
    .code-card { border: 1px solid #ccc; background: #f9f9f9; padding: 10px; margin-bottom: 8px; border-radius: 6px; }
    .code-card input { width: 75%; font-size: 1em; }
    .meta { font-size: 0.9em; color: #555; }
    #status {
      white-space: pre-line; margin: 10px 0; padding: 10px;
      border: 1px solid #ccc; border-radius: 6px; background: #f4f4f4;
    }
  </style>
</head>
<body>
  <h2>ğŸ“· ì¿ í° ì½”ë“œ OCR ì¸ì‹ê¸°</h2>
  <p>í™”ë©´ì„ ë“œë˜ê·¸í•´ì„œ ì½”ë“œê°€ ìˆëŠ” ì˜ì—­ì„ ì„ íƒí•˜ì„¸ìš”. ìë¦¿ìˆ˜ë„ ê¼­ ì„¤ì •í•´ì£¼ì„¸ìš”.</p>
  <video id="preview" autoplay playsinline muted style="display:none;"></video>
  <canvas id="canvas" width="1280" height="720"></canvas>

  <div class="controls">
    ìë¦¿ìˆ˜:
    <select id="lengthSelect">
      ${[...Array(9)].map((_, i) => `<option value="${i + 8}">${i + 8}ìë¦¬</option>`).join('')}
    </select>
    <button onclick="exportCodes()">Export</button>
    <button onclick="copyToClipboard()">Copy</button>
    <button onclick="shareCodes()">Share</button>
  </div>

  <div id="status">â³ ì¤€ë¹„ ì¤‘...</div>
  <div id="code-list"></div>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const statusDiv = document.getElementById("status");
    const codeListDiv = document.getElementById("code-list");
    const lengthSelect = document.getElementById("lengthSelect");
    const video = document.getElementById("preview");
    const codeMap = new Map();
    let startX = null, startY = null, endX = null, endY = null, dragging = false;

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => {
        video.srcObject = stream;
        video.play();
        requestAnimationFrame(drawFrame);
        setStatus("âœ… ì¹´ë©”ë¼ ì—°ê²°ë¨. ì˜ì—­ì„ ë“œë˜ê·¸í•˜ì„¸ìš”.");
      })
      .catch(err => setStatus("âŒ ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: " + err.message));

    function setStatus(text) { statusDiv.innerText = text; }

    function getCoords(e) {
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const touch = e.touches ? e.touches[0] : e;
      return {
        x: (touch.clientX - rect.left) * scaleX,
        y: (touch.clientY - rect.top) * scaleY
      };
    }

    function beginDrag(e) {
      const { x, y } = getCoords(e);
      startX = x; startY = y; dragging = true;
    }

    function updateDrag(e) {
      if (!dragging) return;
      const { x, y } = getCoords(e);
      endX = x; endY = y;
    }

    function endDrag() {
      dragging = false;
      if (startX && endX) setTimeout(runOCR, 300);
    }

    canvas.addEventListener("mousedown", beginDrag);
    canvas.addEventListener("mousemove", updateDrag);
    canvas.addEventListener("mouseup", endDrag);
    canvas.addEventListener("touchstart", beginDrag, { passive: false });
    canvas.addEventListener("touchmove", updateDrag, { passive: false });
    canvas.addEventListener("touchend", endDrag);

    function drawFrame() {
      if (video.readyState >= 2) {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        if (startX != null && endX != null) {
          ctx.strokeStyle = "red";
          ctx.lineWidth = 2;
          ctx.strokeRect(startX, startY, endX - startX, endY - startY);
        }
      }
      requestAnimationFrame(drawFrame);
    }

    function runOCR() {
      if (!startX || !endX || !startY || !endY) return;
      const w = endX - startX, h = endY - startY;
      if (w <= 0 || h <= 0) return setStatus("â— ì˜ëª»ëœ ì˜ì—­ì…ë‹ˆë‹¤.");

      const crop = ctx.getImageData(startX, startY, w, h);
      const temp = document.createElement("canvas");
      temp.width = w; temp.height = h;
      temp.getContext("2d").putImageData(crop, 0, 0);
      const img = temp.toDataURL("image/png");

      setStatus("ğŸ“¸ OCR ì²˜ë¦¬ ì¤‘...");

      Tesseract.recognize(img, "eng", {
        tessedit_char_whitelist: "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890",
        psm: 7
      }).then(result => {
        const text = result.data.text.trim();
        const len = parseInt(lengthSelect.value);
        const regex = new RegExp(`\\b[A-Z0-9]{${len}}\\b`, "g");
        const matches = text.match(regex);
        setStatus(`ğŸ§  OCR ê²°ê³¼:\n${text}`);
        if (matches) {
          matches.forEach(code => {
            if (![...codeMap.values()].includes(code)) {
              const key = new Date().toISOString().replace(/[-:.TZ]/g, "");
              codeMap.set(`${key}_${codeMap.size}`, code);
              renderCodes();
            }
          });
        } else {
          setStatus("âš ï¸ ì½”ë“œ ì¸ì‹ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        }
      }).catch(err => setStatus("âŒ OCR ì˜¤ë¥˜: " + err.message));
    }

    function renderCodes() {
      codeListDiv.innerHTML = "";
      [...codeMap.entries()].reverse().forEach(([key, code]) => {
        const div = document.createElement("div");
        div.className = "code-card";
        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = key;
        const input = document.createElement("input");
        input.value = code;
        input.onchange = () => codeMap.set(key, input.value);
        const del = document.createElement("button");
        del.textContent = "ğŸ—‘";
        del.onclick = () => { codeMap.delete(key); renderCodes(); };
        div.appendChild(meta); div.appendChild(input); div.appendChild(del);
        codeListDiv.appendChild(div);
      });
    }

    function exportCodes() {
      const text = [...codeMap.entries()].map(([k, c]) => `${k} : ${c}`).join("\n");
      const blob = new Blob([text], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "coupon_codes.txt";
      link.click();
    }

    function copyToClipboard() {
      const text = [...codeMap.entries()].map(([k, c]) => `${k} : ${c}`).join("\n");
      navigator.clipboard.writeText(text).then(() => alert("ğŸ“‹ ë³µì‚¬ ì™„ë£Œ"));
    }

    function shareCodes() {
      const text = [...codeMap.entries()].map(([k, c]) => `${k} : ${c}`).join("\n");
      if (navigator.share) {
        navigator.share({ title: "ì¿ í° ì½”ë“œ", text });
      } else {
        alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ê³µìœ  ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      }
    }
  </script>
</body>
</html>
